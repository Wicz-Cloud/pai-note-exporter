name: Code Quality Gates

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

# Set minimal required permissions for quality checks
permissions:
  contents: read
  statuses: write

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quality-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-quality-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check test coverage
      run: |
        pytest --cov=src/pai_note_exporter --cov-report=xml --cov-fail-under=80
        coverage report --fail-under=80

    - name: Check code quality metrics
      run: |
        # Count lines of code
        echo "Lines of code:"
        find src -name "*.py" -exec wc -l {} + | tail -1

        # Check for TODO/FIXME comments
        todo_count=$(grep -r "TODO\|FIXME\|XXX" src/ | wc -l)
        if [ "$todo_count" -gt 10 ]; then
          echo "::warning::High number of TODO/FIXME comments: $todo_count"
        fi

        # Check for print statements in production code
        print_count=$(grep -r "^\s*print(" src/pai_note_exporter/ | grep -v "__main__" | wc -l)
        if [ "$print_count" -gt 0 ]; then
          echo "::error::Found $print_count print statements in production code"
          exit 1
        fi

    - name: Check for large files
      run: |
        # Warn about files larger than 1MB
        find . -type f -size +1M -not -path "./.git/*" -not -path "./venv/*" | while read file; do
          echo "::warning::Large file detected: $file ($(du -h "$file" | cut -f1))"
        done

    - name: Validate documentation
      run: |
        # Check if README has required sections
        if ! grep -q "## Installation" README.md; then
          echo "::error::README.md missing Installation section"
          exit 1
        fi

        if ! grep -q "## Usage" README.md; then
          echo "::error::README.md missing Usage section"
          exit 1
        fi

        # Check for Python files without docstrings (basic check)
        python_files=$(find src -name "*.py" | head -5)
        for file in $python_files; do
          if ! head -3 "$file" | grep -q '"""'; then
            echo "::warning::$file appears to be missing module docstring"
          fi
        done
